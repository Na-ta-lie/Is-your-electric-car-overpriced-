---
title: "Is Your Electric Vehicle Overpriced?"
author: "Natalie Stier"
output: 
  slidy_presentation:
    css: bootstrap.min.css
runtime: shiny
date: "2024-01-08"
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(car)
library(MASS)
library(repr)
library(pals)
library(shinythemes)
library(plotly)
library(bslib)
library(ggpubr)
library(revealjs)
library(shiny)

ecars = read.csv('ecars.csv')
ecars_vars = ecars[,4:10]
ecars_make  = ecars %>% group_by(Make) %>%
  filter(n()>=10)
most_makes = read.csv('most_makes.csv')
predicted_price = read.csv('predicted_price.csv')

makes = most_makes$Make 

ecars$Make2 = ifelse(ecars$Make %in% makes, ecars$Make, "zOther")
make_other = unique(ecars$Make2)
make_other = sort(make_other)
make_other[15] = 'Other'

price_model_initial = lm(Price ~ Efficiency + Fast_charge + 
                        Range + Top_speed + 
                        Acceleration, data = ecars)
bc = boxCox(price_model_initial)
lambda = bc$x[which(bc$y == max(bc$y))]

model <- readRDS("model.rds")

             
make_colors = c('#e6194b', '#f58231',  '#ffe119', 
                '#bcf60c','#3cb44b', '#008080',
                '#aaffc3', '#4363d8', '#000075',
                '#46f0f0', '#911eb4', '#e6beff',
                '#f032e6', '#fabebe')
              

make_colors2 = c('#e6194b', '#f58231',  '#ffe119', 
                '#bcf60c','#3cb44b', '#008080',
                '#aaffc3', '#4363d8', '#000075',
                '#46f0f0', '#911eb4', '#e6beff',
                '#f032e6', '#fabebe', 'black')

make_other = unique(ecars$Make2)
make_other = sort(make_other)
make_other[15] = 'Other'
make_other
#shiny plot outputs 

# box plot of any variable 
 output$p1 <- renderPlotly({
  plot_ly(
      data = ecars,
      x = ~get(input$var),
      type = "box",
      text = ~Car_name,
      name = ' ',
      tooltip = c("x", "text")) %>% 
      layout(title = "Box Plot of Selected Feature",
             yaxis = list(title = ''),
             xaxis = list(title = ''))
   
  })
  
#boxplot of any variable by Make
  output$p2 <- renderPlotly({
     plot_ly(
      data = ecars_make,
      x = ~get(input$var),
      y = ~Make,
      type = "box",
      color = ~Make,
      colors = make_colors,
      text = ~Car_name,
      tooltip = c("x", "text"),
      showlegend = FALSE
              )%>% 
      layout(title = "Selected Feature (Makes with 10 + Models)",
             yaxis = list(title = ''),
             xaxis = list(title = ''))
    
  })
  

 output$histogram <- renderPlot({
    ggplot(ecars, aes(x=!!input$var)) + 
      geom_histogram(color="black", fill="white", bins = 15)+
      ggtitle('Distribution of Selected Feature')+ theme(plot.title = element_text(size=18))  
    
  })  
#histogram of variable  
 
# bar graph of variable 


# variable relationships 

```

## Background Information and Research Question:

* Research Question

Based on an electric model's features what should it's price be?

* Why Electric Cars?

I wanted to work with a data set lending itself to a multiple linear regression.

According to [Autoweek](https://www.autoweek.com/news/a44900159/are-electric-cars-worth-it/) electric cars are typically $6000 to $7000 more than their gas counterparts:

> Some electric cars are the same or less money than their gas counterparts, but others are much more expensive.  
> It all depends on the car, the price of electricity, the rate of depreciation, if you're eligible for any incentives, and much more.

**The more you know about your investment the better.** 

## The data set 

This collection of data on electric vehicles came from [Kaggle](https://www.kaggle.com/datasets/fatihilhan/electric-vehicle-specifications-and-prices/). The original set included 360 observations and 9 variables.  
  
  
**Variables**

* Battery: The capacity of the vehicle's battery in kilowatt-hours (kWh).
* Car_name: The model name of the electric vehicle.
* Car_name_link: A direct link to the corresponding page on EV Database for more in-depth information.
* Efficiency: The energy efficiency rating of the vehicle in watt-hours per kilometer (Wh/km).
* Fast_charge: The fast-charging capability of the vehicle in minutes for a certain charging percentage.
* Price.DE.: The price of the electric vehicle in Germany.
* Range: The driving range of the vehicle on a single charge in kilometers.
* Top_speed: The maximum speed the vehicle can achieve in kilometers per hour.
* Acceleration..0.100.: The acceleration time from 0 to 100 kilometers per hour.

## Data Processing and Variables  
<div style= "float:right;position: relative; top: 0px;">

```{r, echo = FALSE, fig.dim = c(9, 7) }
plot(ecars[,4:10],
     main = 'Comparison of all Quantitive Features')

```
</div>
1. I created a Make variable by extracting the first word from the Car_name variable. 
2. I also renamed several columns to make them more intuitive for example I changed acceleration..0.100. to Acceleration.
3. I removed the two cars that did not have fast charge capability (the Renault Twingo Electric and the e.Go e.wave X) because this was an important feature in the linear regression and was impacting their price. 
4. I split the dataframe into two. A dataframe containing cars with prices called ecars (307 objects), and one containing cars missing prices called ecars_missing_price (51 objects). 

After cleaning the data 45 unique car makes were included in the ecars data used to create the linear model and 22 unique car makes were included in the data with missing prices. Additionally 14 makes that have 10 or more car models are highlighted throughout the project.

## Quantitative variables

```{r, echo = FALSE}
inputPanel(
  varSelectInput("var", 
                 tags$span(style="color: #343a40; font-size: 24px;","Feature"), 
                 ecars[,4:10], 
                 selected = "Price")
  )

column(4,
plotlyOutput('p1', width = '500px', height = '550px')
)

column(4,
plotlyOutput('p2', width = '500px', height = '550px')
)

 
column(4, 
       plotOutput('histogram', width = '500px', height = '550px')
)

```

## Quantitative Variable Relationships

```{r, echo = FALSE}
column(2, 
      tags$label(h3('Select Variables')),
      varSelectInput("xvar", 
                     "X variable", 
                     ecars_vars, 
                     selected = "Battery"),
      varSelectInput("yvar", 
                     "Y variable", 
                     ecars_vars, 
                     selected = "Price")
        )
column(8, 
       plotOutput("scatter", height = '800px')
        )
column(2, 
            checkboxGroupInput("make", "Filter by Make",
                                choices = unique(ecars_make$Make), 
                                selected = unique(ecars_make$Make)),
            hr(), # Add a horizontal rule
            checkboxInput("by_make", "Show Make", TRUE),
            checkboxInput("smooth", "Add Smoother")
            )

subsetted <- reactive({
    req(input$var)
    ecars |> filter(Make %in% input$make)
  })
  
output$scatter <- renderPlot({
    p <- ggplot(subsetted(), aes(!!input$xvar, !!input$yvar)) + 
      scale_color_manual(values = make_colors) +
      list(theme(legend.position = "bottom"),
      if (input$by_make) aes(color = Make),
      geom_point(), 
      if (input$smooth) geom_smooth()
    )
    
    p
    
  }, res = 100)

```
## Top Speed vs. Price

Top speed is a fairly good predictor of price. 

```{r, figures-side, fig.show="hold", out.width="50%", echo = FALSE}

 output$makescatter <- renderPlotly({

test = ggplot(ecars, aes(x = Top_speed, y = Price, text = Car_name)) +
  geom_point(aes(col = Make2)) + 
  scale_color_manual(name = "Make", values = make_colors2, labels = make_other)+
  xlab("Top Speed (km/hr)") + 
  ylab("Price in Germany (euros) ") +
  ggtitle('Electric Vehicle Battery vs. Price (Makes with 10+ Models Highlighted)') +
  theme(legend.position = "none")
ggplotly(test, tooltip = c("x", 'y', "text")) 
 })
 
output$barchart <- renderPlot({
ecars %>% group_by(Make) %>%
    filter(n() >= 10) %>%
    summarise(feature = (mean(Price))) %>%
    ggplot(., aes(x = Make, y = feature, fill = Make, label = Make)) +
    geom_bar(stat = 'identity') +
    scale_fill_manual(values = make_colors) +
    ylab('Mean')+
    theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank()) +
    geom_text(angle = 90, position = position_stack(vjust = 0.5)) + 
    theme(legend.position = "none", plot.title = element_text(size=18))+
    ggtitle('Mean Price for each Make with 10+ Models')
})

column(8, plotlyOutput('makescatter', height = '650px'
))
column(4, plotOutput('barchart', height = '650px'
))

```

```{r}
lm_Price_TS = lm(Price ~ Top_speed, ecars)
summary(lm_Price_TS)
```

## Linear Model 
<div style= "float:right;position: relative; top: 0px;">

```{r, echo = FALSE}
summary(model)
```

</div>
1. I started by making a linear model including all the continuous variables. 
2. Using that model and an empty model I did an AIC which eliminated Battery. I expected either Battery or Range to be eliminated because of their co-linearity. 
3. Price is skewed right so I did a BoxCox transformation and then redid the model after transforming the price.

## Linear Model plotly

```{r, echo = FALSE}
column(2,
      sliderInput('xzoom', 'x zoom', 0, 300, 250, ticks = TRUE),
      sliderInput('yzoom', 'y zoom', 0, 300, 250, ticks = TRUE))
column(10,
      plotlyOutput('MLR', height = '600px'))

output$MLR <- renderPlotly({
    mlr = ggplot(NULL, aes(Predicted_price, Price)) +
      geom_smooth(data = predicted_price, aes(x = Predicted, y = Predicted), 
                  col = 'blue', size = .8, alpha = .5) +
      geom_smooth(data = predicted_price, aes(x = Predicted, y = Predict_lwr), 
                  col = 'red', linetype = 'dashed', size = .8, alpha = .8) +
      geom_smooth(data = predicted_price, aes(x = Predicted, y = Predict_upr), 
                  col = 'red', linetype = 'dashed',size = .8, alpha = .8) +
      geom_smooth(data = predicted_price, aes(x = Predicted, y = Confidence_lwr), 
                  col = 'black', linetype = 'dashed', size = .8, alpha = .8) +
      geom_smooth(data = predicted_price, aes(x = Predicted, y = Confidence_upr), 
                  col = 'black', linetype = 'dashed', size = .8, alpha = .8) +
      geom_point(data = predicted_price, aes(x = Predicted, y = Price, text = Name), alpha = .5) +
      theme(legend.position = "right", legend.text = element_text(size = 8))+
      ylim(25, input$yzoom) + xlim(25, input$xzoom) +
      labs(title = "Predicted Price vs. Price for all EV Models",
           caption = "Data source: ToothGrowth",
           x = "Predicted price (euros in thousands)", y = "German Price (euros in thousands)",
           tag = "A")
    
    ggplotly(mlr, tooltip = c("x", 'y', "text")) 
  })
  
```

